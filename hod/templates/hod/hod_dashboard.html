{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HOD Dashboard | MCE Syllabus Maker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --mce-blue: #123e77;
      --mce-red: #b72b3f;
      --muted: #6b7378;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Roboto, Arial, sans-serif;
      background: #f4f6f8;
      color: #222;
    }
    .topbar {
      background: var(--mce-blue);
      color: #fff;
      padding: 6px 14px;
      font-size: 13px;
      text-align: center;
    }
    header.site {
      background: #fff;
      border-bottom: 4px solid #eee;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand img {
      height: 68px;
      width: auto;
      display: block;
    }
    .brand .title { font-weight: 700; color: var(--mce-blue); font-size: 18px; }
    .brand .sub { font-size: 13px; color: var(--muted); }
    .hero {
      background-image: linear-gradient(rgba(18,62,119,0.55), rgba(18,62,119,0.55)), url("{% static 'images/images.jpg' %}");
      background-size: cover;
      background-position: center;
      padding: 36px 0;
      color: #fff;
    }
    .hero-inner { max-width:1200px;margin:0 auto;padding:0 16px;display:flex;align-items:center;justify-content:space-between;gap:16px; }
    .hero-text h1 { margin:0;font-size:24px;font-weight:700; }
    .hero-text p { margin:6px 0 0;color:rgba(255,255,255,0.95);font-size:14px; }
    main.container { max-width:1100px;margin:22px auto;padding:0 16px; }
    .card { background:#fff;border-radius:10px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,0.06);margin-bottom:20px; }
    .grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:16px; }
    .btn { padding:10px 14px;background:var(--mce-red);color:#fff;border-radius:6px;border:0;cursor:pointer;font-weight:600; }
    .btn-outline-primary {
      padding: 10px 14px;
      background: transparent;
      color: var(--mce-blue);
      border: 2px solid var(--mce-blue);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    .btn-outline-primary:hover {
      background: var(--mce-blue);
      color: #fff;
    }
    .btn-disabled {
      padding: 10px 14px;
      background: #eee;
      color: #999;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: inline-block;
      cursor: not-allowed;
      text-decoration: none;
    }
    .logout-btn { background:#444;padding:8px 12px;color:#fff;border-radius:6px;border:0;cursor:pointer; }
    table { width:100%;border-collapse:collapse;font-size:13px;margin-top:8px; }
    th, td { padding:10px;text-align:left;border-bottom:1px solid #eee; }
    th { background:#f4f6f8;font-weight:600; }
    .small-muted { color:var(--muted); font-size:13px; }

    /* Sidebar collapsed styles kept as before */
    .sidebar-menu { background: #fff; border-right: 2px solid #ddd; padding: 20px 0; width: 200px; position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto; z-index: 999; box-shadow: 2px 0 8px rgba(0,0,0,0.08); transform: translateX(-100%); transition: transform 0.3s ease; }
    .sidebar-menu.open { transform: translateX(0); }
    .menu-toggle { display: none; background: var(--mce-blue); color: #fff; border: none; padding: 12px 16px; cursor: pointer; font-size: 18px; font-weight: 700; position: fixed; top: 110px; left: 16px; z-index: 1000; border-radius: 6px; transition: all 0.3s ease; }
    .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 998; }
    @media (max-width: 768px) { .menu-toggle { display: block; } main.container { margin-left: 0 !important; } }
  </style>
</head>
<body>
  <div class="topbar">Affiliated to Visvesvaraya Technological University | Accredited by AICTE, NBA</div>

  <header class="site">
    <div class="wrap">
      <div class="brand">
        <img src="{% static 'images/malnad_college_of_engineering_logo.jpeg' %}" alt="MCE Logo">
        <div>
          <div class="title">Malnad College of Engineering</div>
          <div class="sub">Syllabus Maker ‚Äî HOD Dashboard</div>
        </div>
      </div>
      <div style="text-align:right">
        <form method="post" action="{% url 'users:logout' %}" style="display:inline">
          {% csrf_token %}
          <button type="submit" class="logout-btn">Logout</button>
        </form>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-inner">
      <div class="hero-text">
        <h1>HOD Dashboard ‚Äî {{ branch.name }} {% if branch.code %} ({{ branch.code }}) {% endif %}</h1>
        <p>Manage department scheme, assign faculty and generate departmental syllabus documents.</p>
      </div>
    </div>
  </section>

  <div class="sidebar-menu">
    <h2>‚ò∞ Menu</h2>
    <ul>
        <li>
          <a href="{% url 'hod:dashboard_self' branch.pk %}" class="{% if request.resolver_match.url_name == 'dashboard_self' %}active{% endif %}">üìä Dashboard</a>
        </li>
        <li>
          {% if selected_year and selected_semester %}
            <a href="{% url 'hod:faculty_assignments_detail' branch.pk %}?year={{ selected_year }}&semester={{ selected_semester }}"
               class="{% if request.resolver_match.url_name == 'faculty_assignments_detail' %}active{% endif %}">Faculty Assignments</a>
          {% else %}
            <a href="{% url 'hod:faculty_assignments_detail' branch.pk %}" class="{% if request.resolver_match.url_name == 'faculty_assignments_detail' %}active{% endif %}">Faculty Assignments</a>
          {% endif %}
        </li>
        <li>
          <a href="{% url 'hod:activity_history' %}" class="{% if request.resolver_match.url_name == 'activity_history' %}active{% endif %}">üìã Activity History</a>
        </li>
    </ul>
  </div>

  <button class="menu-toggle" id="menu-toggle">‚ò∞ MENU</button>
  <div class="menu-overlay"></div>

  <main class="container" style="margin-left: 220px;">
    <!-- HOD PDF controls -->
    <div class="card" style="margin-bottom:18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between">
      <div style="flex:1;min-width:240px">
        <form method="get" action="{% url 'hod:dashboard_self' branch.pk %}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input name="year" placeholder="Admission year e.g. 2025" value="{{ selected_year }}" style="padding:8px;border-radius:6px;border:1px solid #ddd;flex:1;min-width:150px">
          <select name="semester" style="padding:8px;border-radius:6px;border:1px solid #ddd;background:#fff;">
            <option value="">Select Semester</option>
            {% for i in "12345678"|make_list %}
              <option value="{{ i }}" {% if selected_semester == i %}selected{% endif %}>Semester {{ i }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit" style="background:var(--mce-red)">Show Courses</button>
        </form>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Courses provided by Dean (read-only)</h2>
      <p class="small-muted" style="margin:0 0 12px;">
        These are college-level courses set by the Dean. HOD can view the syllabus and assign faculty.
        {% if not selected_year or not selected_semester %}
          <br><strong style="color:#b72b3f">Please select admission year and semester above to view courses and credits.</strong>
        {% endif %}
      </p>
      {% if selected_year and selected_semester %}
        {% if courses_dean %}
          <table>
            <thead>
              <tr>
                <th>Code</th><th>Title</th><th style="text-align:center">L-T-P</th><th style="text-align:center">Credits</th><th style="text-align:center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for c in courses_dean %}
                <tr>
                  <td>{{ c.course_code }}</td>
                  <td>{{ c.course_title }}</td>
                  <td style="text-align:center">{{ c.l }}-{{ c.t }}-{{ c.p }}</td>
                  <td style="text-align:center">{{ c.credits }}</td>
                  <td style="text-align:center;">
                    {% if c.syllabus_pk %}
                      <a href="{% url 'academics:view_syllabus_pdf' c.syllabus_pk %}" target="_blank" rel="noopener">View</a>
                    {% else %}
                      <a href="{% url 'academics:course_latest_syllabus' c.id %}" target="_blank" rel="noopener">View Dean Syllabus</a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:#666">No dean-provided courses found for Semester {{ selected_semester }} of {{ selected_year }}.</p>
        {% endif %}

        <!-- Add these two buttons here -->
        <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
          <a href="{% url 'hod:create_scheme' branch.pk selected_year selected_semester %}" class="btn" style="background:#1e88e5;padding:10px 18px;border-radius:6px;text-decoration:none;display:inline-block;">Create Schema for this Semester</a>
          
          <a href="{% url 'hod:manage_schemes' branch.pk %}" class="btn btn-outline-primary" style="padding:10px 18px;border-radius:6px;text-decoration:none;display:inline-block;">Manage Scheme PDFs</a>
        </div>
      {% endif %}
    </div>

    {% if selected_year and selected_semester %}
      <div class="card" style="text-align:left;">
        <h3 style="margin:0 0 8px;">Assigned Faculty & Faculty Syllabi</h3>
        <p class="small-muted" style="margin:0 0 12px;">
          Review HOD/Dean course assignments and the syllabi submitted by faculty below. Approve faculty syllabi to include them in the combined departmental syllabus.
        </p>

        <!-- Faculty-submitted syllabi area (pending approval) -->
        <div style="margin-top:18px;">
          <h4 style="margin:0 0 8px;">Faculty Syllabi Submitted (Pending approval)</h4>
          {% if pending_submissions %}
            <table>
              <thead>
                <tr>
                  <th>Course</th>
                  <th>Faculty</th>
                  <th style="text-align:center">Submitted On</th>
                  <th style="text-align:center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for s in pending_submissions %}
                  <tr>
                    <td>{{ s.course.course_code }} ‚Äî {{ s.course.course_title }}</td>
                    <td>{{ s.faculty.get_full_name|default:s.faculty.username }}</td>
                    <td style="text-align:center">{{ s.submitted_on|date:"d M Y" }}</td>
                    <td style="text-align:center">
                      <a href="{% url 'hod:view_submission' s.pk %}" target="_blank" rel="noopener">View</a>
                      <form method="post" action="{% url 'hod:approve_syllabus' s.pk %}" style="display:inline;margin-left:8px;">
                        {% csrf_token %}
                        <button class="btn" type="submit" style="background:#2e7d32;padding:6px 10px;border-radius:4px;">Approve</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p style="color:#666;margin:6px 0;">No pending syllabi from faculty at the moment.</p>
          {% endif %}
        </div>

        <!-- Faculty-generated PDFs (Uploaded) -->
        <div style="margin-top:18px;">
          <h4 style="margin:0 0 8px;">Faculty-generated Syllabi (Uploaded)</h4>

          {# Inserted snippet per request: shows uploaded PDFs + approve button #}
          {% if faculty_pdfs %}
            <table>
              <thead>
                <tr>
                  <th>PDF</th>
                  <th>Uploaded By</th>
                  <th>Uploaded On</th>
                  <th style="text-align:center">Approved</th>
                  <th style="text-align:center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for pdf in faculty_pdfs %}
                  <tr>
                    <td>
                      {% if pdf.pdf_file %}
                        <a href="{{ pdf.pdf_file.url }}" target="_blank">View PDF</a>
                      {% else %}
                        (file missing)
                      {% endif %}
                    </td>
                    <td>
                      {% if pdf.created_by %}
                        {{ pdf.created_by.get_full_name|default:pdf.created_by.username }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                    <td>{{ pdf.created_at|date:"d M Y H:i" }}</td>
                    <td style="text-align:center">
                      {% if pdf.approved %} ‚úÖ Approved {% else %} ‚ùå {% endif %}
                    </td>
                    <td style="text-align:center">
                      {% if not pdf.approved %}
                        <form method="post" action="{% url 'hod:approve_faculty_pdf' pdf.pk %}" style="display:inline">
                          {% csrf_token %}
                          <button class="btn" type="submit" style="background:#2e7d32;padding:6px 8px;border-radius:4px;color:#fff;">Approve</button>
                        </form>
                      {% else %}
                        <span style="color:#666">‚Äî</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p style="color:#666;margin:6px 0;">No faculty-generated PDFs found for Year {{ selected_year }}, Semester {{ selected_semester }}.</p>
          {% endif %}

        </div>

        <!-- Action buttons -->
        <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
          {# Open selection page where HOD can pick scheme PDFs and approved faculty PDFs #}
          <a href="{% url 'hod:create_combined_syllabus' branch.pk %}?year={{ selected_year }}&semester={{ selected_semester }}" class="btn" style="background:#1e88e5;padding:10px 18px;border-radius:6px;color:#fff;text-decoration:none;">Create Combined Syllabus</a>

          <a href="{% url 'hod:faculty_assignments_detail' branch.pk %}?year={{ selected_year }}&semester={{ selected_semester }}" class="btn btn-outline-primary" style="padding:10px 18px;border-radius:6px;text-decoration:none;display:inline-block;">
            Open Assigned Faculty Manager
          </a>

        </div>
      </div>
    {% endif %}

    <!-- Summary Card: Courses (Dean) & Credits for Sem X -->
    {% if selected_year and selected_semester %}
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:32px;margin-bottom:18px;">
        <div>
          <div style="font-size:15px;color:#888;">Courses (Dean)</div>
          <div style="font-size:2em;font-weight:700;">{{ courses_dean|length }}</div>
        </div>
        <div>
          <div style="font-size:15px;color:#888;">Credits for Sem {{ selected_semester }}</div>
          <div style="font-size:2em;font-weight:700;">{{ total_credits_schema|default:"0" }}</div>
        </div>
      </div>
    {% endif %}

    <!-- Collapsible Semester Credits Card -->
    <div class="card">
      <h3 style="margin:0 0 10px;cursor:pointer;" onclick="toggleCreditsTable()">
        Semester Credits for Admission Year {{ selected_year }}
        <span id="toggle-arrow" style="font-size:18px;vertical-align:middle;">&#9660;</span>
      </h3>
      <div id="credits-table" style="display:none;">
        {% if semester_rows %}
          <table>
            <thead>
              <tr>
                <th>Semester</th>
                <th style="text-align:center">Credits</th>
                <th style="text-align:center">Manage</th>
              </tr>
            </thead>
            <tbody>
              {% for sem, credits in semester_rows %}
                <tr>
                  <td>{{ sem }}</td>
                  <td style="text-align:center">{{ credits }}</td>
                  <td style="text-align:center">
                    <form method="post" action="{% url 'hod:select_semester' branch.pk %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="academic_year" value="{{ selected_year }}">
                      <input type="hidden" name="semester" value="{{ forloop.counter }}">
                      <button class="btn" type="submit">Manage Schema</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:#666">No semester credit record found for {{ selected_year }}.</p>
        {% endif %}
      </div>
    </div>

    <script>
    function toggleCreditsTable() {
      var table = document.getElementById('credits-table');
      var arrow = document.getElementById('toggle-arrow');
      if (table.style.display === 'none') {
        table.style.display = 'block';
        arrow.innerHTML = '&#9650;';
      } else {
        table.style.display = 'none';
        arrow.innerHTML = '&#9660;';
      }
    }

    const sidebarMenu = document.querySelector('.sidebar-menu');
    const menuToggle = document.querySelector('.menu-toggle');
    const menuOverlay = document.querySelector('.menu-overlay');
    const menuLinks = document.querySelectorAll('.sidebar-menu ul li a');

    if (menuToggle) {
      menuToggle.addEventListener('click', () => {
        sidebarMenu.classList.toggle('open');
        menuOverlay.classList.toggle('show');
      });
    }
    menuOverlay.addEventListener('click', () => {
      sidebarMenu.classList.remove('open');
      menuOverlay.classList.remove('show');
    });
    menuLinks.forEach(link => {
      link.addEventListener('click', () => {
        sidebarMenu.classList.remove('open');
        menuOverlay.classList.remove('show');
      });
    });
    document.addEventListener('click', (event) => {
      if (!sidebarMenu.contains(event.target) && !menuToggle.contains(event.target)) {
        sidebarMenu.classList.remove('open');
        menuOverlay.classList.remove('show');
      }
    });
    </script>
  </main>
</body>
</html>
